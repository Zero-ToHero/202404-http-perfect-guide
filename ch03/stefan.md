## HTTP 메시지

> 요약
- 메시지가 어떻게 흘러가는가
- HTTP 메시지의 세 부분 (시작줄, 헤더, 개체 본문)
- 요청과 응답 메시지 차이
- 요청 메시지가 지원하는 여러 기능들
- 응답 메시지가 반환하는 여러 상태 코드들
- 여러 HTTP 헤더들은 무슨 일을 하는가

### 메시지의 흐름
- HTTP 메시지는 HTTP 애플리케이션 간 주고받은 데이터 블록들

#### 메시지는 서버 방향을 인바운드로 하여 송신된다.
- inbound / outbound는 트랜잭션 방향을 표현하기 위한 용어
- `기준은 서버`
  - 인바운드: 클라 -> 서버
  - 아웃바운드: 서버 -> 클라

#### 다운스트림으로 흐르는 메시지
- 요청인지 응답인지에 상관없이 모든 메시지는 `다운스트림`으로 흐른다.
- 메시지의 발송자는 수신자의 `업스트림`이다. (무조건 보내는 쪽이 업스트림)

### 메시지의 각 부분
- 메시지는 데이터가 구조화된 단순한 블록
- 시작줄 / 헤더 / 본문으로 나뉜다.
  1. 시작줄: 어떤 메시지인지
  2. 헤더: 속성
  3. 본문 (optional): 데이터

#### 메시지 문법
- 모든 HTTP 메시지는 요청 메시지 아니면 응답 메시지이다.
  - 요청 메시지: 웹 서버에 어떤 동작을 요구한다.
  - 응답 메시지: 요청의 결과를 클라에 돌려준다.
1. 메서드
- 서버에서 어떤 리소스에 대해 해줬으면 하는 `동작`을 의미
- GET, POST, PUT, DELETE 등이 있다.
2. 요청 URL
- 요청 대상이 되는 리소스를 지칭하는 경로
3. 버젼
- 메시지에서 사용중인 HTTP 버젼
4. 상태 코드
- 요청 중에 무엇이 일어났는지 설명하는 세 자리의 숫자.
5. 사유 구절(reason-phrase)
- 상태 코드의 의미를 설명하는 짧은 문구
- 상태 코드 이후부터 줄바꿈 문자열까지를 사유 구절이라고 한다.
6. 헤더들
- 헤더의 목록은 빈줄(CRLF)로 끝난다.
7. 엔터티 본문
- 임의의 데이터 블록을 포함한다.
- 없을 수도 있다.

### 메서드
#### 안전한 메서드(Safe Method)
- 안전한 메서드란 서버(서버 데이터)에 영향을 주지 않는 메서드를 의미.
- GET, HEAD가 여기에 속한다.
- POST, PUT, PATCH, DELETE는 서버 데이터에 변경을 유발한다.
- 안전한 메서드가 서버에 변경을 유발하지 않는다는 보장은 없다. (개발자가 하기 나름)

#### GET
- 서버에게 리소스를 달라고 요청하기 위해 사용됨.
#### HEAD
- 서버는 응답으로 헤더만을 돌려준다.
- 리소스를 가져오지 않고, 리소스의 존재 여부 또는 변경 여부를 파악하기 위해 사용됨.
#### PUT
- PUT은 서버에 데이터를 추가하거나, 수정하기 위해 사용한다.
#### POST
- 서버에 데이터를 전송하기 위해 사용
#### TRACE
- 클라-서버 사이에 있는 모든 HTTP 애플리케이션을 따라가면서 데이터가 변경이나 망가졌는지 여부를 진단하기 위해 사용
#### OPTIONS
- 서버에게 특정 리소스에게 어떤 메서드가 지원되는지 확인하기 위해 사용.
- OPTIONS 요청에 대한 응답으로 받은 메서드 이외의 다른 메서드를 사용하는 경우, 요청이 막힌다.
- 예시로는 `CORS preflight` 요청이 있다.
#### DELETE
- 리소스 삭제하기 위해 사용

### 상태 코드
#### 100 ~ 199: 정보성 상태코드
| 상태 코드 | 사유 구절               | 설명                                                |
|-------|---------------------|---------------------------------------------------|
| 100   | Continue            | 클라가 서버에 엔터티 본문을 전송하기 전에 서버가 받아들일지 여부를 확인하기 위해 사용. |
| 101   | Switching Protocols | 클라가 upgrade헤더에 나열한 것 중 하나로 서버가 프로토콜을 바꾼 것을 의미     |

#### 200 ~ 299: 성공 상태 코드
| 상태 코드 | 사유 구절           | 설명                                                           |
|-------|-----------------|--------------------------------------------------------------|
| 200   | OK              | 요청 정상, 엔터티 본문에 요청한 리소스를 포함.                                  |
| 201   | Created         | 서버에 데이터 추가 요청(e.g. POST, PUT) 성공.<br>생성된 데이터에 대한 구체적인 참조가 담긴 Location 헤더, 그 리소스를 참조할 수 있는 여러 URL을 엔터티 본문에 포함해야함.<br><br>예를 들면, 방금 새로 생성한 게시글의 id를 엔터티 본문에 포함시켜 응답으로 돌려주는 것들이 있다. |
| 202   | Accepted        | 서버가 요청을 받아들인 것을 나타내는 상태 코드.<br><br>서버는 해당 요청을 처리할지 말지는 정하지 않은 상태. |
| 204   | No Content      | 주로 브라우저를 새 경로(html)로 이동시키지 않고, 페이지 갱신할 때 쓰임.                 |
| 205   | Reset Content   | 브라우저에게 현재 페이지에 있는 모든 html form에 채워진 값을 비우라고 할 때 사용           |
| 206   | Partial Content | 부분 or 범위 요청 성공.<br>206 응답은 Content-Range와 Date 헤더를 반드시 포함해야한다.<br>또, Etag or Content-Location중 하나의 헤더도 반드시 포함해야한다. |

#### 300 ~ 399: 리다이렉션 상태 코드

- 리다이렉션 상태 코드는 클라가 요청한 리소스에 대해 `다른 위치`에 있다고 하거나 `다른 대안`을 제공할 때 사용한다.

| 상태 코드 | 사유 구절              | 설명                                                           |
|-------|--------------------|--------------------------------------------------------------|
| 300   | Multiple Choices   | 클라가 동시에 여러 리소스를 가리키는 URL을 요청한 경우, 그 리소스의 목록과 함께 반환.<br><br>다국어를 지원하는 글로벌 서비스의 경우, 다른 언어의 페이지를 반환할 때 사용 가능.<br><br>Location 헤더에 선호하는 URL을 포함시킬 수 있다. |
| 301   | Moved Permanently  | 요청한 URL이 redirect되었을 때 사용.<br>응답은 Location 헤더에 현재 리소스가 존재하고 있는 URL을 포함해야함. |
| 302   | Found              | 301과 동일. 클라는 Location 헤더로 주어진 URL을 리소스를 임시로 가리키기 위한 목적으로 사용해야함.<br>이후 요청에서는 원래 URL을 사용해야함. |
| 303   | See Other          | 클라에게 리소스를 다른 URL에서 가져와야 한다고 말해줄 때 사용.<br>새 URL은 응답 메시지의 Location 헤더에 들어있다.<br>주 목적은 POST 요청에 대한 응답으로 클라에게 리소스 위치 알려줄 때 사용. |
| 304   | Not Modified       | 시간 기반의 캐싱할때 주로 사용. 요청한 리소스가 최근에 수정된 일이 없을 때 이 상태 코드를 반환.<br>304를 동반한 응답은 엔터티 본문을 가져서는 안된다. |
| 305   | Use Proxy          | 리소스에 접근시 반드시 프록시를 거쳐야하는 것을 나타내기 위해 사용함.<br>프록시의 위치는 Location 헤더를 통해 주어진다. |
| 307   | Temporary Redirect | 301과 비슷하지만 클라는 Location 헤더로 주어진 URL을 리소스를 임시로 가리키기 위한 목적으로 사용해야하고, 이후 요청에서는 원래의 URL을 사용해야한다. |

#### 400 ~ 499: 클라이언트 에러 상태 코드
| 상태 코드 | 사유 구절                           | 설명                                                           |
|-------|---------------------------------|--------------------------------------------------------------|
| 400   | Bad Request                     | 클라가 요청을 잘못 보냄                                                |
| 401   | Unauthorized                    | 인증이 필요한 리소스 접근시 인증을 요구하기 위한 상태 코드                            |
| 402   | Payment Required                | 현재에는 안 쓰이고, 미래에 쓰일 것 같아서 만들어 놓은 코드                           |
| 403   | Forbidden                       | 요청이 서버에 거부었음을 알리기 위해 사용한다. 거부의 이유를 숨기고 싶을 때 사용               |
| 404   | Not Found                       | 서버가 요청한 리소스를 찾을 수 없을 때 사용                                    |
| 405   | Method Not Allowed              | 요청한 URL에 대해서 지원하지 않는 메서드로 요청받을 때에 사용                         |
| 406   | Not Acceptable                  | 주어진 URL에 대한 리소스 중 클라가 받아들일 수 있는 것이 없는 경우에 사용되는 상태.<br>종종 서버는 클라에게 요청이 거절된 이유를 포함한다. |
| 407   | Proxy Authentication Required   | 401과 동일. 프록시 서버가 인증을 요구할 때 사용                                |
| 408   | Request Timeout                 | 요청을 완수하기에 시간이 너무 많이 걸릴때, 서버에서 연결을 끊기 위해 사용하는 상태 코드           |
| 409   | Conflict                        | 서버는 요청이 충돌을 유발할 것 같을 때 이 상태 코드를 사용.<br>응답에 충돌에 대해 설명하는 본문 포함. |
| 410   | Gone                            | 404와 비슷. 예전에는 있었는데 지금은 없어진 리소스에 대해 클라에게 설명하기 위해 사용           |
| 411   | Length Required                 | 서버가 요청에 Content-Length 헤더를 포함시킬 것을 요구할 때 사용                  |
| 412   | Precondition Failed             | 클라가 보낸 조건부 요청이 실패한 경우 사용.<br><br>Expect 헤더가 포함된 요청을 조건부 요청이라고 한다. |
| 413   | Request Entity Too Large        | 서버가 처리할 수 없는 크기의 요청이 왔을때 사용                                  |
| 414   | Request URI Too Long            | 서버가 처리할 수 없는 길이의 URI에 대해서 사용하는 상태 코드                         |
| 415   | Unsupported Media Type          | 서버가 이해하거나 지원하지 못하는 타입의 엔터티를 보냈을 때 사용                         |
| 416   | Requested Range Not Satisfiable | 요청에서 리소스의 특정 범위를 요청했는데, 그 범위가 잘못된 경우에 사용                     |
| 417   | Expectation Failed              | Expect 요청 헤더에 서버가 만족시킬 수 없는 기댓값이 담겨있는 경우에 사용.                |

#### 500 ~ 599: 서버 에러 상태 코드
- 서버 자체 이슈 or 게이트웨이 리소스 등의 요소에서 발생한 에러

| 상태 코드 | 사유 구절                      | 설명                                                           |
|-------|----------------------------|--------------------------------------------------------------|
| 500   | Internal Server Error      | 서버 에러                                                        |
| 501   | Not Implemented            | 서버의 능력을 넘은 요청을 했을 때 사용                                       |
| 502   | Bad Gateway                | 프록시 or 게이트웨이처럼 행동하는 서버가 다음 목적지로 통신할 수 없을 때 사용.               |
| 503   | Service Unavailable        | 현재는 서버가 처리할 수 없는 요청이지만, 나중엔 가능한 요청임을 나타내기 위해 사용              |
| 504   | Gateway Timeout            | 408과 비슷하지만, 다른 서버에게 요청을 보내고 응답을 기다리다 타임아웃이 발생한 상황이다.<br>게이트웨이 or 프록시에서 온 응답이라는 것이 다르다. |
| 505   | HTTP Version Not Supported | 프로토콜 버젼 문제                                                   |

### 헤더
- 헤더와 메서드는 클라와 서버가 무엇을 하는지 결정하기 위해 함께 사용된다.
- 헤더는 일반 목적으로 사용할 수 있는 헤더, 요청이나 응답, 둘 중 하나의 메시지에만 사용할 수 있는 헤더, 요청/응답 양쪽 모두에서 사용할 수 있는 헤더로 나뉜다.

#### 일반 헤더

- 클라와 서버 모두가 사용.

| 헤더           | 설명                                      |
|--------------|-----------------------------------------|
| Connection   | 클라와 서버가 요청/응답 연결에 대한 옵션 기입              |
| Date         | 메시지 생성 날짜와 시간                           |
| MIME-Version | 발송자가 사용한 MIME 버젼 기입                     |
| Upgrade      | 발송자가 업그레이드하길 원하는 새 버젼이나 프로토콜을 알려줌.      |
| Via          | 이 메시지가 어떤 중개자(프록시, 게이트웨이)를 거쳐 왔는지 보여준다. |

- **일반 캐시 헤더**
  - 로컬 복사본으로 캐시할 수 있는 헤더

| 헤더                                    | 설명                                     |
|---------------------------------------|----------------------------------------|
| Cache-Control                         | 메시지와 함께 캐시 지시자를 전달하기 위해 사용<br>         |
| Pragma(deprecated. use Cache-Control) | 메시지와 함께 지시자를 전달하는 또다른 방법. 캐시에 국한되지 않음. |

#### 요청 헤더
- 요청 메시지에서만 의미를 갖는 헤더
- 요청에 대한 정보를 준다.

| 헤더         | 설명                         |
|------------|----------------------------|
| Client-IP  | 클라가 실행된 컴퓨터의 IP            |
| From       | 클라 사용자의 메일주소               |
| Host       | 요청 대상이 되는 서버의 host, port   |
| Referer    | 현재의 요청 URI가 들어 있었던 문서의 URL |
| UA-*       | 클라의 기기에 대한 정보를 제공          |
| User-Agent | 요청을 보낸 app의 이름을 서버에게 전달    |

- **Accept 관련 헤더**
  - 클라가 서버에게 자신의 선호외 능력을 알려줄 수 있다. (e.g. 타입)
  
| 헤더              | 설명          |
|-----------------|-------------|
| Accept          | 허용하는 미디어 종류 |
| Accept-Charset  | 허용하는 문자집합   |
| Accept-Encoding | 허용하는 인코딩    |
| Accept-Language | 허용하는 언어     |
| TE              | 허용 확장 전송 코딩 |

- **조건부 요청 헤더**

| 헤더                  | 설명                                 |
|---------------------|------------------------------------|
| Expect              | 클라가 요청에 필요한 서버의 행동을 나열             |
| If-Match            | 일치하는 문서의 엔터티 태그에 해당하는 문서를 가져옴      |
| If-Modified-Since   | 주어진 날짜 이후에 리소스 변경된 경우에만 요청 수행      |
| If-None-Match       | 일치하지 않는 문서의 엔터티 태그에 해당하는 문서를 가져옴   |
| If-Range            | 문서의 특정 범위에 대한 요청                   |
| If-Unmodified-Since | 주어진 날짜 이후에 리소스가 변경되지 않은 경우에만 요청 수행 |
| Range               | 리소스에 대한 특정 범위 요청할때 사용              |

- **요청 보안 헤더**

| 헤더            | 설명                        |
|---------------|---------------------------|
| Authorization | 클라가 서버에게 제공하는 인증 관련 정보    |
| Cookie        | 클라가 서버에게 토큰 전달할 때 사용      |
| Cookie2       | 요청자가 지원하는 쿠키 버젼을 알려줄 때 사용 |

- **프록시 요청 헤더**

| 헤더                  | 설명                                                           |
|---------------------|--------------------------------------------------------------|
| Max-Forwards        | 요청이 최종 목적지인 서버까지 향하는 과정에서 다른 프록시나 게이트웨이를 거칠 수 있는 최대 횟수. TRACE 메서드와 함께 쓴다. |
| Proxy-Authorization | 프록시에서 쓰이는 인증 관련 정보                                           |
| Proxy-Connection    | Connection과 같으나 프록시용                                         |

#### 응답 헤더
| 헤더          | 설명                                            |
|-------------|-----------------------------------------------|
| Age         | 응답이 얼마나 오래되었는지                                |
| Public      | 서버가 특정 리소스에 대해 지원하는 요청 메서드 목록                 |
| Retry-After | 현재 리소스가 사용 불가능한 상태일 때, 언제 가능해지는지에 대한 날짜 or 시간 |
| Server      | 서버 애플리케이션의 이름과 버젼                             |
| Title       | HTML 문서에서 사용하는 title과 같은 메타 정보                |
| Warning     | 사유 구절보다 더 자세한 경고 메시지                          |

- **협상 헤더**
  - 다국어와 같이 하나의 리소스에 대해 여러가지 표현이 가능한 경우에 사용하는 헤더
  
| 헤더            | 설명                                   |
|---------------|--------------------------------------|
| Accept-Ranges | 서버가 자원에 대해 받아들일 수 있는 범위의 형태          |
| Vary          | 서버의 확인이 필요하며, 응답에 영향을 줄 수 있는 헤더들의 목록 |

- **응답 보안 헤더**

| 헤더                 | 설명                                    |
|--------------------|---------------------------------------|
| Proxy-Authenticate | 프록시에서 클라로 보낸 인증 요구의 목록                |
| Set-Cookie         | 서버가 클라를 인증할 수 있도록 클라쪽에 토큰을 설정하기 위해 사용 |
| Set-Cookie2        | 위와 유사. RFC2965로 정의된 쿠키                |
| WWW-Authenticate   | 서버에서 클라로 보낸 인증 요구의 목록                 |

#### 엔터티 헤더
- 요청/응답 양쪽 모두 포함 가능
- 개체 타입, 리소스 요청 메서드들 등 많은 정보 제공

| 헤더       | 설명                                                           |
|----------|--------------------------------------------------------------|
| Allow    | 이 엔터티에 수행할 수 있는 요청 메서드들 나열                                   |
| Location | 클라가 엔터티가 실제로 어디 위치하는지 알려주기 위해 사용. <br>수신자에게 리소스의 새로운 위치를 알려줄 때 사용. |

- **콘텐츠 헤더**
  - 엔터티 콘텐츠에 대한 구체적인 정보 제공

| 헤더               | 설명                                  |
|------------------|-------------------------------------|
| Content-Base     | 본문에서 사용된 상대 URL의 기저                 |
| Content-Encoding | 인코딩                                 |
| Content-Language | 자연어                                 |
| Content-Length   | 길이 or 크기                            |
| Content-Location | 리소스의 실제 위치                          |
| Content-MD5      | MD5의 checksum                       |
| Content-Range    | 전체 리소스에서 이 엔터티가 해당하는 범위를 byte단위로 표현 |
| Content-Type     | 어떤 종류인지                             |

- **엔터티 캐싱 헤더**
  - 일반 캐싱 헤더는 `시간 기반`이었다면, 엔터티 캐싱헤더는 `내용 기반`이다.
  
| 헤더            | 설명                                  |
|---------------|-------------------------------------|
| ETag          | 이 엔터티에 대한 엔터티 태그                    |
| Expires       | 이 엔터티가 더이상 유효하지 않아 원본을 다시 받아와야하는 일시 |
| Last-Modified | 이 엔터티가 변경된 가장 최근의 시간                |
